{% extends "base.html" %}

{% block title %}Панель администратора - BolashakBot{% endblock %}

{% block head %}
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
/* --- Custom Dashboard Styles --- */
.admin-dashboard {
    padding-top: 30px;
    padding-bottom: 30px;
    background: #f5f8fa;
}
.dashboard-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 32px;
}
.dashboard-header h1 {
    font-weight: 700;
    font-size: 2.3rem;
    color: #32325d;
}
.dashboard-actions .btn {
    font-weight: 500;
    margin-right: 10px;
}
.stats-cards .card {
    border: none;
    border-radius: 18px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    text-align: center;
}
.stats-cards .card .card-body i {
    font-size: 2.2rem;
    margin-bottom: 10px;
}
.stats-cards .card .fw-bold {
    font-size: 1.9rem;
}
.section-title {
    font-weight: 600;
    color: #2d3748;
    margin-bottom: 18px;
}
.dashboard-nav .btn {
    font-size: 1.05rem;
    border-radius: 12px;
    margin-bottom: 12px;
    padding: 12px 0;
}
.dashboard-nav .btn i {
    font-size: 1.1rem;
}
.metric-card {
    padding: 15px;
    border-radius: 8px;
    background: #f8f9fa;
    margin-bottom: 10px;
}
.metric-value {
    font-size: 2rem;
    font-weight: bold;
    margin-bottom: 5px;
}
.metric-label {
    font-size: 0.9rem;
    color: #6c757d;
}
.card-header {
    background: #fff;
    border-bottom: none;
    padding: 1rem 1.25rem 0.5rem 1.25rem;
}
.card {
    border-radius: 16px;
    box-shadow: 0 2px 12px rgba(0,0,0,0.07);
}
.table thead th {
    background: #f5f8fa;
    font-weight: 600;
    color: #495057;
}
.table-striped tbody tr:nth-of-type(odd) {
    background-color: #f8f9fa;
}
.badge {
    font-size: 0.95rem;
    border-radius: 7px;
    padding: 6px 12px;
}
.bg-gradient-primary {
    background: linear-gradient(45deg,#0d6efd,#3b82f6)!important;
}
.bg-gradient-success {
    background: linear-gradient(45deg,#198754,#22c55e)!important;
}
.bg-gradient-warning {
    background: linear-gradient(45deg,#ffc107,#f59e42)!important;
}
.bg-gradient-info {
    background: linear-gradient(45deg,#0dcaf0,#06b6d4)!important;
}
.bg-gradient-secondary {
    background: linear-gradient(45deg,#6c757d,#64748b)!important;
}
.bg-gradient-dark {
    background: linear-gradient(45deg,#212529,#334155)!important;
}
.bg-gradient-light {
    background: linear-gradient(45deg,#f8f9fa,#e2e8f0)!important;
}
</style>
{% endblock %}

{% block content %}
<div class="container admin-dashboard">
    <div class="dashboard-header">
        <h1><i class="fas fa-tachometer-alt me-2"></i> Панель администратора</h1>
        <div class="dashboard-actions">
            <button onclick="refreshAnalytics()" class="btn btn-primary">
                <i class="fas fa-sync-alt me-2"></i> Обновить данные
            </button>
            <a href="{{ url_for('admin.logout') }}" class="btn btn-outline-secondary">
                <i class="fas fa-sign-out-alt me-2"></i> Выйти
            </a>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row stats-cards mb-4 g-3">
        <div class="col-6 col-md-3">
            <div class="card bg-gradient-primary text-white h-100">
                <div class="card-body">
                    <i class="fas fa-comments"></i>
                    <div class="fw-bold">{{ total_queries or 0 }}</div>
                    <div class="small">Всего запросов</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-gradient-success text-white h-100">
                <div class="card-body">
                    <i class="fas fa-question-circle"></i>
                    <div class="fw-bold">{{ total_faqs or 0 }}</div>
                    <div class="small">Активных FAQ</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-gradient-warning text-dark h-100">
                <div class="card-body">
                    <i class="fas fa-folder"></i>
                    <div class="fw-bold">{{ total_categories or 0 }}</div>
                    <div class="small">Категорий</div>
                </div>
            </div>
        </div>
        <div class="col-6 col-md-3">
            <div class="card bg-gradient-info text-white h-100">
                <div class="card-body">
                    <i class="fas fa-clock"></i>
                    <div class="fw-bold">{{ avg_response_time or 0 }}s</div>
                    <div class="small">Среднее время ответа</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <span class="section-title"><i class="fas fa-robot me-2"></i>Статистика агентов</span>
                </div>
                <div class="card-body">
                    <canvas id="agentUsageChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <span class="section-title"><i class="fas fa-language me-2"></i>Распределение по языкам</span>
                </div>
                <div class="card-body">
                    <canvas id="languageChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <span class="section-title"><i class="fas fa-clock me-2"></i>Время ответа агентов</span>
                </div>
                <div class="card-body">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card h-100">
                <div class="card-header">
                    <span class="section-title"><i class="fas fa-check-circle me-2"></i>Успешность агентов</span>
                </div>
                <div class="card-body">
                    <canvas id="successRateChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Usage Trend -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <span class="section-title"><i class="fas fa-chart-line me-2"></i>Активность агентов за последние 30 дней</span>
                </div>
                <div class="card-body">
                    <canvas id="dailyUsageChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Knowledge Base Statistics -->
    <div class="row mb-4 g-3">
        <div class="col-12 col-md-4">
            <div class="card bg-gradient-secondary text-white h-100">
                <div class="card-body">
                    <i class="fas fa-file-text"></i>
                    <div class="fw-bold">{{ total_documents or 0 }}</div>
                    <div class="small">Документов загружено</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card bg-gradient-dark text-white h-100">
                <div class="card-body">
                    <i class="fas fa-globe"></i>
                    <div class="fw-bold">{{ total_web_sources or 0 }}</div>
                    <div class="small">Веб-источников</div>
                </div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="card bg-gradient-light text-dark h-100">
                <div class="card-body">
                    <i class="fas fa-database"></i>
                    <div class="fw-bold">{{ total_kb_chunks or 0 }}</div>
                    <div class="small">Фрагментов в базе знаний</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Menu -->
    <div class="row mb-4 dashboard-nav">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <span class="section-title">Управление</span>
                    <div class="row">
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.categories') }}" class="btn btn-outline-primary w-100">
                                <i class="fas fa-folder me-2"></i> Управление категориями
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.faqs') }}" class="btn btn-outline-success w-100">
                                <i class="fas fa-question-circle me-2"></i> Управление FAQ
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.queries') }}" class="btn btn-outline-info w-100">
                                <i class="fas fa-comments me-2"></i> Просмотр запросов
                            </a>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.documents') }}" class="btn btn-outline-warning w-100">
                                <i class="fas fa-file-text me-2"></i> Управление документами
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.web_sources') }}" class="btn btn-outline-secondary w-100">
                                <i class="fas fa-globe me-2"></i> Веб-источники
                            </a>
                        </div>
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.knowledge_base') }}" class="btn btn-outline-dark w-100">
                                <i class="fas fa-database me-2"></i> База знаний
                            </a>
                        </div>
                    </div>
                    <div class="row mt-3">
                        <div class="col-md-4">
                            <a href="{{ url_for('admin.agent_knowledge') }}" class="btn w-100" style="background-color: rgba(168, 85, 247, 0.1); border-color: #A855F7; color: #A855F7;">
                                <i class="fas fa-users-cog me-2"></i> Базы знаний агентов
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Queries -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <span class="section-title">Последние запросы пользователей</span>
                </div>
                <div class="card-body">
                    {% if recent_queries %}
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Время</th>
                                        <th>Сообщение пользователя</th>
                                        <th>Агент</th>
                                        <th>Язык</th>
                                        <th>Время ответа</th>
                                        <th>Уверенность</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for query in recent_queries %}
                                    <tr>
                                        <td>{{ query.created_at.strftime('%d.%m.%Y %H:%M') }}</td>
                                        <td>{{ query.user_message[:60] }}{% if query.user_message|length > 60 %}...{% endif %}</td>
                                        <td>
                                            {% if query.agent_name %}
                                                <span class="badge bg-info">{{ query.agent_name }}</span>
                                            {% else %}
                                                <span class="badge bg-secondary">Не определен</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <span class="badge bg-{{ 'primary' if query.language == 'ru' else 'success' }}">
                                                {{ 'РУС' if query.language == 'ru' else 'ҚАЗ' }}
                                            </span>
                                        </td>
                                        <td>{{ "%.2f"|format(query.response_time or 0) }}s</td>
                                        <td>
                                            {% if query.agent_confidence %}
                                                <span class="badge bg-{{ 'success' if query.agent_confidence >= 0.7 else 'warning' if query.agent_confidence >= 0.4 else 'danger' }}">
                                                    {{ "%.1f"|format(query.agent_confidence * 100) }}%
                                                </span>
                                            {% else %}
                                                <span class="badge bg-secondary">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-inbox fa-3x mb-3"></i>
                            <p>Пока нет запросов от пользователей</p>
                        </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Аналитика оценок -->
    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <span class="section-title">📊 Статистика оценок</span>
                </div>
                <div class="card-body">
                    <div id="ratingStats" class="text-center">
                        <div class="row">
                            <div class="col-4">
                                <div class="metric-card">
                                    <div class="metric-value text-success" id="totalLikes">-</div>
                                    <div class="metric-label">👍 Лайки</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="metric-card">
                                    <div class="metric-value text-danger" id="totalDislikes">-</div>
                                    <div class="metric-label">👎 Дизлайки</div>
                                </div>
                            </div>
                            <div class="col-4">
                                <div class="metric-card">
                                    <div class="metric-value text-info" id="satisfactionRate">-</div>
                                    <div class="metric-label">% Удовлетв.</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <span class="section-title">📈 Оценки по агентам</span>
                </div>
                <div class="card-body">
                    <canvas id="agentRatingChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Тренды оценок -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <span class="section-title">📊 Тренд оценок за последние 30 дней</span>
                </div>
                <div class="card-body">
                    <canvas id="ratingTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chart colors
    const chartColors = {
        primary: '#0d6efd',
        success: '#198754',
        danger: '#dc3545',
        warning: '#ffc107',
        info: '#0dcaf0',
        secondary: '#6c757d',
        purple: '#A855F7',
        pink: '#d63384',
        orange: '#fd7e14'
    };

    // Load agent analytics data
    async function loadAgentAnalytics() {
        try {
            const response = await fetch('/admin/api/analytics/summary');
            if (!response.ok) throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            const data = await response.json();
            if (data.error) throw new Error(data.error);
            const hasData = (data.agent_usage && data.agent_usage.length > 0) ||
                            (data.language_distribution && data.language_distribution.length > 0) ||
                            (data.daily_activity && data.daily_activity.length > 0);
            if (!hasData) return;
            createAgentUsageChart(data.agent_usage || []);
            createLanguageChart(data.language_distribution || []);
            createResponseTimeChart(data.agent_usage || []);
            createSuccessRateChart(data.agent_usage || []);
            createDailyUsageChart(data.daily_activity || []);
        } catch (error) {
            console.error('Error loading analytics:', error);
        }
    }

    // Agent Usage Pie Chart
    function createAgentUsageChart(data) {
        if (!data || !Array.isArray(data) || data.length === 0) return;
        const ctx = document.getElementById('agentUsageChart').getContext('2d');
        const colors = Object.values(chartColors);
        new Chart(ctx, {
            type: 'pie',
            data: {
                labels: data.map(item => item.name || 'Неизвестный'),
                datasets: [{
                    data: data.map(item => item.count || 0),
                    backgroundColor: colors.slice(0, data.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }

    // Language Distribution Chart
    function createLanguageChart(data) {
        if (!data || !Array.isArray(data) || data.length === 0) return;
        const ctx = document.getElementById('languageChart').getContext('2d');
        const languageData = data.reduce((acc, item) => {
            const lang = item.language || 'unknown';
            acc[lang] = (acc[lang] || 0) + (item.count || 0);
            return acc;
        }, {});
        const labels = Object.keys(languageData).map(lang => {
            switch(lang) {
                case 'ru': return 'Русский';
                case 'kz': return 'Қазақша';
                default: return 'Неизвестный';
            }
        });
        new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: Object.values(languageData),
                    backgroundColor: [chartColors.primary, chartColors.success, chartColors.secondary],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'bottom' } }
            }
        });
    }

    // Response Time Bar Chart
    function createResponseTimeChart(data) {
        if (!data || !Array.isArray(data) || data.length === 0) return;
        const ctx = document.getElementById('responseTimeChart').getContext('2d');
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: data.map(item => item.name || 'Неизвестный'),
                datasets: [{
                    label: 'Среднее время ответа (сек)',
                    data: data.map(item => item.avg_response_time || 0),
                    backgroundColor: chartColors.info,
                    borderColor: chartColors.info,
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Success Rate Chart
    function createSuccessRateChart(data) {
        if (!data || !Array.isArray(data) || data.length === 0) return;
        const ctx = document.getElementById('successRateChart').getContext('2d');
        const successData = data.map(item => ({
            name: item.name || 'Неизвестный',
            rate: (item.avg_confidence || 0) * 100
        }));
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: successData.map(item => item.name),
                datasets: [{
                    label: 'Уверенность (%)',
                    data: successData.map(item => item.rate),
                    backgroundColor: successData.map(item => 
                        item.rate >= 70 ? chartColors.success :
                        item.rate >= 50 ? chartColors.warning : chartColors.danger
                    ),
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { beginAtZero: true, max: 100 }
                },
                plugins: { legend: { display: false } }
            }
        });
    }

    // Daily Usage Line Chart
    function createDailyUsageChart(data) {
        if (!data || !Array.isArray(data) || data.length === 0) return;
        const ctx = document.getElementById('dailyUsageChart').getContext('2d');
        const sortedData = data.sort((a, b) => new Date(a.date) - new Date(b.date));
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: sortedData.map(item => {
                    const date = new Date(item.date);
                    return date.toLocaleDateString('ru-RU');
                }),
                datasets: [{
                    label: 'Количество запросов',
                    data: sortedData.map(item => item.count || 0),
                    borderColor: chartColors.primary,
                    backgroundColor: chartColors.primary + '20',
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } }
            }
        });
    }

    // Rating analytics
    async function loadRatingAnalytics() {
        try {
            const response = await fetch('/admin/api/analytics/summary');
            const data = await response.json();
            if (data.error) return;
            const ratingStats = data.rating_stats || {};
            document.getElementById('totalLikes').textContent = ratingStats.likes || 0;
            document.getElementById('totalDislikes').textContent = ratingStats.dislikes || 0;
            document.getElementById('satisfactionRate').textContent = (ratingStats.satisfaction_rate !== undefined ? ratingStats.satisfaction_rate.toFixed(1) : 0) + '%';
            if (data.rating_by_agent && data.rating_by_agent.length > 0) {
                renderAgentRatingChart(data.rating_by_agent);
            }
            if (data.daily_ratings && data.daily_ratings.length > 0) {
                renderRatingTrendChart(data.daily_ratings);
            }
        } catch (error) {
            console.error('Ошибка при загрузке аналитики оценок:', error);
        }
    }

    function renderAgentRatingChart(ratingByAgent) {
        const ctx = document.getElementById('agentRatingChart').getContext('2d');
        const agents = [...new Set(ratingByAgent.map(item => item.agent_name || 'Неизвестный'))];
        const likesData = agents.map(agent => {
            const likes = ratingByAgent.find(item => item.agent_name === agent && item.rating === 'like');
            return likes ? likes.count : 0;
        });
        const dislikesData = agents.map(agent => {
            const dislikes = ratingByAgent.find(item => item.agent_name === agent && item.rating === 'dislike');
            return dislikes ? dislikes.count : 0;
        });
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: agents,
                datasets: [
                    { label: '👍 Лайки', data: likesData, backgroundColor: '#22c55e', borderRadius: 4 },
                    { label: '👎 Дизлайки', data: dislikesData, backgroundColor: '#ef4444', borderRadius: 4 }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } }
            }
        });
    }

    function renderRatingTrendChart(dailyRatings) {
        const ctx = document.getElementById('ratingTrendChart').getContext('2d');
        const dates = [...new Set(dailyRatings.map(item => item.date))].sort();
        const likesData = dates.map(date => {
            const likes = dailyRatings.find(item => item.date === date && item.rating === 'like');
            return likes ? likes.count : 0;
        });
        const dislikesData = dates.map(date => {
            const dislikes = dailyRatings.find(item => item.date === date && item.rating === 'dislike');
            return dislikes ? dislikes.count : 0;
        });
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: dates,
                datasets: [
                    {
                        label: '👍 Лайки',
                        data: likesData,
                        borderColor: '#22c55e',
                        backgroundColor: 'rgba(34, 197, 94, 0.1)',
                        tension: 0.3,
                        fill: true
                    },
                    {
                        label: '👎 Дизлайки',
                        data: dislikesData,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            },
            options: {
                responsive: true,
                plugins: { legend: { position: 'top' } }
            }
        });
    }

    // Load analytics on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadAgentAnalytics();
        loadRatingAnalytics();
    });

    // Refresh
    function refreshAnalytics() {
        loadAgentAnalytics();
        loadRatingAnalytics();
    }
    window.refreshAnalytics = refreshAnalytics;
</script>
{% endblock %}